<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAROENG MASHER - Dashboard Penjualan</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* GAYA UNTUK DASHBOARD PENJUALAN */
        body { 
            font-family: 'Montserrat', sans-serif; 
            background-color: #1A1A1A; /* Latar belakang sangat gelap */
            color: #E0E0E0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        h1, h2, h3, h4, h5, h6, .navbar-brand { 
            font-family: 'Lora', serif; 
            font-weight: 700; 
            color: #FFFFFF;
        }
        .navbar-brand { 
            color: #FFD700 !important; /* Brand dengan warna emas/kuning cerah */
            font-size: 1.8rem;
            letter-spacing: 1px;
        }
        .navbar {
            background-color: #282828 !important; /* Navbar gelap */
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .sidebar {
            background-color: #282828;
            min-height: calc(100vh - 56px);
            border-right: 1px solid #333333;
        }
        .sidebar .nav-link {
            color: #E0E0E0;
            padding: 12px 20px;
            transition: all 0.3s;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background-color: #333333;
            color: #FFD700;
        }
        .sidebar .nav-link i {
            margin-right: 10px;
        }
        .content {
            padding: 20px;
            flex-grow: 1;
        }
        .card {
            background-color: #282828;
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #333333;
            border-bottom: 1px solid #444;
            color: #FFD700;
            font-weight: 600;
        }
        .stat-card {
            background-color: #333333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-card .stat-icon {
            font-size: 2rem;
            color: #FFD700;
            margin-bottom: 10px;
        }
        .stat-card .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #FFFFFF;
        }
        .stat-card .stat-label {
            font-size: 0.9rem;
            color: #B0B0B0;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .table-dark {
            background-color: #333333;
        }
        .table-dark th, .table-dark td {
            border-color: #444;
        }
        .btn-primary {
            background-color: #FFD700;
            border-color: #FFD700;
            color: #1A1A1A;
        }
        .btn-primary:hover {
            background-color: #E0B400;
            border-color: #E0B400;
        }
        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
            border-color: #c82333;
        }
        .date-filter {
            background-color: #333333;
            border: 1px solid #555;
            color: #E0E0E0;
        }
        .date-filter:focus {
            background-color: #333333;
            color: #E0E0E0;
            border-color: #FFD700;
            box-shadow: 0 0 0 0.25rem rgba(255, 215, 0, 0.25);
        }
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        .top-product {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #444;
        }
        .top-product:last-child {
            border-bottom: none;
        }
        .top-product-rank {
            font-size: 1.5rem;
            font-weight: 700;
            color: #FFD700;
            margin-right: 15px;
            min-width: 30px;
        }
        .top-product-info {
            flex-grow: 1;
        }
        .top-product-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        .top-product-sales {
            font-size: 0.9rem;
            color: #B0B0B0;
        }
        .top-product-revenue {
            font-weight: 700;
            color: #FFFFFF;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #B0B0B0;
        }
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #555;
        }
        .reset-warning {
            background-color: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .reset-warning i {
            color: #dc3545;
            margin-right: 10px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .navbar-brand {
                font-size: 1.2rem;
            }
            
            .content {
                padding: 10px;
            }
            
            .stat-card {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .stat-card .stat-value {
                font-size: 1.5rem;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .table-responsive {
                font-size: 0.85rem;
            }
            
            .sidebar {
                position: fixed;
                top: 56px;
                left: -100%;
                width: 250px;
                height: calc(100vh - 56px);
                z-index: 1000;
                transition: left 0.3s ease;
            }
            
            .sidebar.show {
                left: 0;
            }
            
            .sidebar-toggle {
                display: block;
                position: fixed;
                top: 70px;
                left: 10px;
                z-index: 1001;
                background-color: #FFD700;
                color: #1A1A1A;
                border: none;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            }
            
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 56px;
                left: 0;
                width: 100%;
                height: calc(100vh - 56px);
                background-color: rgba(0,0,0,0.5);
                z-index: 999;
            }
            
            .sidebar-overlay.show {
                display: block;
            }
        }
        
        @media (min-width: 769px) {
            .sidebar-toggle, .sidebar-overlay {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="#">ðŸ“Š DASHBOARD - WAROENG MASHER</a>
            <div class="d-flex">
                <a href="index.html" class="btn btn-sm btn-outline-light me-2">
                    <i class="bi bi-cash-stack"></i> Kembali ke POS
                </a>
                <button class="btn btn-sm btn-outline-light me-2" onclick="refreshData()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                <button class="btn btn-sm btn-danger" onclick="showResetConfirmation()">
                    <i class="bi bi-trash"></i> Reset Data
                </button>
            </div>
        </div>
    </nav>

    <button class="sidebar-toggle" onclick="toggleSidebar()">
        <i class="bi bi-list"></i>
    </button>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar p-0 d-none d-md-block" id="sidebar">
                <nav class="nav flex-column">
                    <a class="nav-link active" href="#" onclick="showSection('overview')">
                        <i class="bi bi-speedometer2"></i> Ringkasan
                    </a>
                    <a class="nav-link" href="#" onclick="showSection('daily')">
                        <i class="bi bi-calendar-day"></i> Penjualan Harian
                    </a>
                    <a class="nav-link" href="#" onclick="showSection('weekly')">
                        <i class="bi bi-calendar-week"></i> Penjualan Mingguan
                    </a>
                    <a class="nav-link" href="#" onclick="showSection('monthly')">
                        <i class="bi bi-calendar-month"></i> Penjualan Bulanan
                    </a>
                    <a class="nav-link" href="#" onclick="showSection('products')">
                        <i class="bi bi-box-seam"></i> Produk Terlaris
                    </a>
                    <a class="nav-link" href="#" onclick="showSection('transactions')">
                        <i class="bi bi-receipt"></i> Riwayat Transaksi
                    </a>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 content">
                <!-- Reset Warning -->
                <div id="reset-warning" class="reset-warning" style="display: none;">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <span>Data telah direset. Semua transaksi telah dihapus.</span>
                </div>

                <!-- Overview Section -->
                <div id="overview-section" class="content-section">
                    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                        <h2 class="text-white mb-2 mb-md-0">Ringkasan Penjualan</h2>
                        <div class="d-flex flex-wrap">
                            <input type="date" id="overview-start-date" class="form-control date-filter me-2 mb-2 mb-md-0">
                            <input type="date" id="overview-end-date" class="form-control date-filter me-2 mb-2 mb-md-0">
                            <button class="btn btn-primary" onclick="filterOverviewData()">Terapkan Filter</button>
                        </div>
                    </div>

                    <!-- Stat Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3 col-6">
                            <div class="stat-card">
                                <div class="stat-icon"><i class="bi bi-cash"></i></div>
                                <div class="stat-value" id="total-revenue">Rp 0</div>
                                <div class="stat-label">Total Pendapatan</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="stat-card">
                                <div class="stat-icon"><i class="bi bi-receipt"></i></div>
                                <div class="stat-value" id="total-transactions">0</div>
                                <div class="stat-label">Total Transaksi</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="stat-card">
                                <div class="stat-icon"><i class="bi bi-cart3"></i></div>
                                <div class="stat-value" id="total-items">0</div>
                                <div class="stat-label">Total Item Terjual</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="stat-card">
                                <div class="stat-icon"><i class="bi bi-graph-up"></i></div>
                                <div class="stat-value" id="avg-transaction">Rp 0</div>
                                <div class="stat-label">Rata-rata Transaksi</div>
                            </div>
                        </div>
                    </div>

                    <!-- Revenue Chart -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Grafik Pendapatan</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="revenue-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Daily Sales Section -->
                <div id="daily-section" class="content-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                        <h2 class="text-white mb-2 mb-md-0">Penjualan Harian</h2>
                        <div class="d-flex flex-wrap">
                            <input type="date" id="daily-date" class="form-control date-filter me-2 mb-2 mb-md-0">
                            <button class="btn btn-primary" onclick="filterDailyData()">Tampilkan</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Penjualan per Jam</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="daily-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0">Detail Transaksi</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-dark table-striped">
                                    <thead>
                                        <tr>
                                            <th>ID Transaksi</th>
                                            <th>Waktu</th>
                                            <th>Item</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="daily-transactions-table">
                                        <!-- Data will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Weekly Sales Section -->
                <div id="weekly-section" class="content-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                        <h2 class="text-white mb-2 mb-md-0">Penjualan Mingguan</h2>
                        <div class="d-flex flex-wrap">
                            <input type="date" id="weekly-start-date" class="form-control date-filter me-2 mb-2 mb-md-0">
                            <input type="date" id="weekly-end-date" class="form-control date-filter me-2 mb-2 mb-md-0">
                            <button class="btn btn-primary" onclick="filterWeeklyData()">Tampilkan</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Penjualan per Hari</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="weekly-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Kategori Terlaris</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="weekly-category-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Metode Pembayaran</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="weekly-payment-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monthly Sales Section -->
                <div id="monthly-section" class="content-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                        <h2 class="text-white mb-2 mb-md-0">Penjualan Bulanan</h2>
                        <div class="d-flex flex-wrap">
                            <select id="monthly-month" class="form-control date-filter me-2 mb-2 mb-md-0">
                                <option value="0">Januari</option>
                                <option value="1">Februari</option>
                                <option value="2">Maret</option>
                                <option value="3">April</option>
                                <option value="4">Mei</option>
                                <option value="5">Juni</option>
                                <option value="6">Juli</option>
                                <option value="7">Agustus</option>
                                <option value="8">September</option>
                                <option value="9">Oktober</option>
                                <option value="10">November</option>
                                <option value="11">Desember</option>
                            </select>
                            <select id="monthly-year" class="form-control date-filter me-2 mb-2 mb-md-0">
                                <!-- Options will be populated by JavaScript -->
                            </select>
                            <button class="btn btn-primary" onclick="filterMonthlyData()">Tampilkan</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Penjualan per Hari</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="monthly-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Perbandingan Bulan Ini vs Bulan Lalu</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="monthly-comparison-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Tren Pendapatan 6 Bulan Terakhir</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="monthly-trend-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top Products Section -->
                <div id="products-section" class="content-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                        <h2 class="text-white mb-2 mb-md-0">Produk Terlaris</h2>
                        <div class="d-flex flex-wrap">
                            <select id="products-period" class="form-control date-filter me-2 mb-2 mb-md-0">
                                <option value="today">Hari Ini</option>
                                <option value="week">Minggu Ini</option>
                                <option value="month">Bulan Ini</option>
                                <option value="year">Tahun Ini</option>
                            </select>
                            <button class="btn btn-primary" onclick="filterProductsData()">Tampilkan</button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Grafik Produk Terlaris</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="top-products-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Daftar Produk Terlaris</h5>
                                </div>
                                <div class="card-body p-0" id="top-products-list">
                                    <!-- Top products list will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transactions Section -->
                <div id="transactions-section" class="content-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                        <h2 class="text-white mb-2 mb-md-0">Riwayat Transaksi</h2>
                        <div class="d-flex flex-wrap">
                            <input type="date" id="transactions-start-date" class="form-control date-filter me-2 mb-2 mb-md-0">
                            <input type="date" id="transactions-end-date" class="form-control date-filter me-2 mb-2 mb-md-0">
                            <button class="btn btn-primary" onclick="filterTransactionsData()">Tampilkan</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                            <h5 class="mb-0">Daftar Transaksi</h5>
                            <button class="btn btn-sm btn-outline-light" onclick="exportTransactions()">
                                <i class="bi bi-download"></i> Export
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-dark table-striped">
                                    <thead>
                                        <tr>
                                            <th>ID Transaksi</th>
                                            <th>Tanggal & Waktu</th>
                                            <th>Kasir</th>
                                            <th>Item</th>
                                            <th>Total</th>
                                            <th>Detail</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactions-table">
                                        <!-- Data will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                            <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-center" id="transactions-pagination">
                                    <!-- Pagination will be inserted here -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loading-state" class="loading-spinner" style="display: none;">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="empty-state" style="display: none;">
                    <i class="bi bi-inbox"></i>
                    <h4>Tidak Ada Data</h4>
                    <p>Belum ada data penjualan untuk periode yang dipilih.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Detail Modal -->
    <div class="modal fade" id="transactionDetailModal" tabindex="-1" aria-labelledby="transactionDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="transactionDetailModalLabel">Detail Transaksi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="transaction-detail-content">
                        <!-- Transaction details will be inserted here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary" onclick="printTransactionDetail()">
                        <i class="bi bi-printer"></i> Cetak
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div class="modal fade" id="resetConfirmationModal" tabindex="-1" aria-labelledby="resetConfirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="resetConfirmationModalLabel">
                        <i class="bi bi-exclamation-triangle-fill"></i> Konfirmasi Reset Data
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Anda yakin ingin mereset semua data penjualan?</p>
                    <p class="text-danger"><strong>Peringatan:</strong> Tindakan ini akan menghapus SEMUA data transaksi secara permanen dan tidak dapat dibatalkan.</p>
                    <ul>
                        <li>Semua riwayat transaksi akan dihapus</li>
                        <li>Semua data penjualan akan diatur ke nol</li>
                        <li>Semua grafik akan menampilkan data kosong</li>
                    </ul>
                    <p>Ketik <code>RESET</code> untuk konfirmasi:</p>
                    <input type="text" id="reset-confirmation-input" class="form-control" placeholder="Ketik RESET">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-danger" id="confirm-reset-btn" disabled onclick="resetAllData()">
                        <i class="bi bi-trash"></i> Reset Semua Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
        // --- INISIALISASI FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBhRCNri0TjBdMx9fEN8jgAfDD-jV_FdNo",
            authDomain: "waroengmasher.firebaseapp.com",
            projectId: "waroengmasher",
            storageBucket: "waroengmasher.firebasestorage.app",
            messagingSenderId: "984134106741",
            appId: "1:984134106741:web:81d129033d09475173c23c",
            measurementId: "G-7RRW43T1LT"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- VARIABEL GLOBAL ---
        let transactions = [];
        let charts = {};
        let currentSection = 'overview';
        let currentPage = 1;
        const itemsPerPage = 10;

        // --- FUNGSI HELPER ---
        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
        }

        function formatDate(date) {
            return new Date(date).toLocaleDateString('id-ID');
        }

        function formatDateTime(date) {
            return new Date(date).toLocaleString('id-ID');
        }

        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(el => {
                el.style.display = 'none';
            });
            
            // Show selected section
            document.getElementById(`${section}-section`).style.display = 'block';
            
            // Update active nav link
            document.querySelectorAll('.sidebar .nav-link').forEach(el => {
                el.classList.remove('active');
            });
            
            // Find the correct nav link and set it as active
            document.querySelectorAll('.sidebar .nav-link').forEach(el => {
                if (el.getAttribute('onclick').includes(section)) {
                    el.classList.add('active');
                }
            });
            
            currentSection = section;
            
            // Close mobile sidebar if open
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
            
            // Load data for the selected section
            loadSectionData(section);
        }

        function loadSectionData(section) {
            showLoadingState();
            
            switch(section) {
                case 'overview':
                    loadOverviewData();
                    break;
                case 'daily':
                    loadDailyData();
                    break;
                case 'weekly':
                    loadWeeklyData();
                    break;
                case 'monthly':
                    loadMonthlyData();
                    break;
                case 'products':
                    loadProductsData();
                    break;
                case 'transactions':
                    loadTransactionsData();
                    break;
            }
        }

        function showLoadingState() {
            document.getElementById('loading-state').style.display = 'flex';
            document.getElementById('empty-state').style.display = 'none';
        }

        function hideLoadingState() {
            document.getElementById('loading-state').style.display = 'none';
        }

        function showEmptyState() {
            document.getElementById('empty-state').style.display = 'block';
        }

        function refreshData() {
            loadSectionData(currentSection);
        }

        // Toggle mobile sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        }

        // --- FUNGSI RESET DATA ---
        function showResetConfirmation() {
            const modal = new bootstrap.Modal(document.getElementById('resetConfirmationModal'));
            modal.show();
            
            // Reset input and button
            document.getElementById('reset-confirmation-input').value = '';
            document.getElementById('confirm-reset-btn').disabled = true;
            
            // Add event listener for input
            document.getElementById('reset-confirmation-input').addEventListener('input', function() {
                const input = this.value.toUpperCase();
                document.getElementById('confirm-reset-btn').disabled = input !== 'RESET';
            });
        }

        function resetAllData() {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('resetConfirmationModal'));
            modal.hide();
            
            // Show loading state
            showLoadingState();
            
            // Delete all transactions from Firestore
            db.collection('transactions').get()
                .then(snapshot => {
                    const batch = db.batch();
                    
                    snapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    return batch.commit();
                })
                .then(() => {
                    // Clear local data
                    transactions = [];
                    window.allTransactions = [];
                    
                    // Reset all UI elements to zero
                    resetUIElements();
                    
                    // Show success message
                    document.getElementById('reset-warning').style.display = 'block';
                    setTimeout(() => {
                        document.getElementById('reset-warning').style.display = 'none';
                    }, 5000);
                    
                    // Hide loading state
                    hideLoadingState();
                    
                    // Show empty state
                    showEmptyState();
                })
                .catch(error => {
                    console.error("Error resetting data: ", error);
                    alert('Terjadi kesalahan saat mereset data. Silakan coba lagi.');
                    hideLoadingState();
                });
        }

        function resetUIElements() {
            // Reset stat cards
            document.getElementById('total-revenue').textContent = 'Rp 0';
            document.getElementById('total-transactions').textContent = '0';
            document.getElementById('total-items').textContent = '0';
            document.getElementById('avg-transaction').textContent = 'Rp 0';
            
            // Clear all tables
            document.getElementById('daily-transactions-table').innerHTML = '';
            document.getElementById('transactions-table').innerHTML = '';
            document.getElementById('top-products-list').innerHTML = '';
            
            // Clear all charts
            Object.keys(charts).forEach(key => {
                if (charts[key]) {
                    charts[key].destroy();
                    delete charts[key];
                }
            });
            
            // Create empty charts
            createEmptyCharts();
        }

        function createEmptyCharts() {
            // Create empty revenue chart
            const revenueCtx = document.getElementById('revenue-chart').getContext('2d');
            charts.revenue = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Pendapatan Harian',
                        data: [],
                        backgroundColor: 'rgba(255, 215, 0, 0.2)',
                        borderColor: 'rgba(255, 215, 0, 1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#E0E0E0'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#E0E0E0',
                                callback: function(value) {
                                    return formatRupiah(value);
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#E0E0E0'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
            
            // Create empty charts for other sections if they exist
            const chartIds = [
                'daily-chart', 'weekly-chart', 'weekly-category-chart', 
                'weekly-payment-chart', 'monthly-chart', 'monthly-comparison-chart',
                'monthly-trend-chart', 'top-products-chart'
            ];
            
            chartIds.forEach(id => {
                const canvas = document.getElementById(id);
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    charts[id] = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Data',
                                data: [],
                                backgroundColor: 'rgba(255, 215, 0, 0.7)',
                                borderColor: 'rgba(255, 215, 0, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    labels: {
                                        color: '#E0E0E0'
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        color: '#E0E0E0'
                                    },
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        color: '#E0E0E0'
                                    },
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    }
                                }
                            }
                        }
                    });
                }
            });
        }

        // --- FUNGSI PEMROSESAN DATA ---
        function fetchTransactions(startDate, endDate) {
            return new Promise((resolve, reject) => {
                let query = db.collection('transactions');
                
                if (startDate) {
                    query = query.where('timestamp', '>=', new Date(startDate));
                }
                
                if (endDate) {
                    // Add one day to endDate to include the entire day
                    const endDateTime = new Date(endDate);
                    endDateTime.setDate(endDateTime.getDate() + 1);
                    query = query.where('timestamp', '<', endDateTime);
                }
                
                query.orderBy('timestamp', 'desc')
                    .get()
                    .then(snapshot => {
                        const transactions = [];
                        snapshot.forEach(doc => {
                            transactions.push({
                                id: doc.id,
                                ...doc.data()
                            });
                        });
                        resolve(transactions);
                    })
                    .catch(error => {
                        console.error("Error fetching transactions: ", error);
                        reject(error);
                    });
            });
        }

        function processTransactionsData(transactions) {
            const result = {
                totalRevenue: 0,
                totalTransactions: transactions.length,
                totalItems: 0,
                avgTransaction: 0,
                dailyRevenue: {},
                hourlyRevenue: {},
                weeklyRevenue: {},
                monthlyRevenue: {},
                categoryRevenue: {},
                productSales: {},
                paymentMethods: {}
            };
            
            transactions.forEach(transaction => {
                const date = new Date(transaction.timestamp);
                const dateStr = formatDate(date);
                const hour = date.getHours();
                const weekDay = date.toLocaleDateString('id-ID', { weekday: 'long' });
                const month = date.toLocaleDateString('id-ID', { year: 'numeric', month: 'long' });
                
                // Update totals
                result.totalRevenue += transaction.total;
                result.totalItems += transaction.items.reduce((sum, item) => sum + item.qty, 0);
                
                // Update daily revenue
                if (!result.dailyRevenue[dateStr]) {
                    result.dailyRevenue[dateStr] = 0;
                }
                result.dailyRevenue[dateStr] += transaction.total;
                
                // Update hourly revenue
                if (!result.hourlyRevenue[hour]) {
                    result.hourlyRevenue[hour] = 0;
                }
                result.hourlyRevenue[hour] += transaction.total;
                
                // Update weekly revenue
                if (!result.weeklyRevenue[weekDay]) {
                    result.weeklyRevenue[weekDay] = 0;
                }
                result.weeklyRevenue[weekDay] += transaction.total;
                
                // Update monthly revenue
                if (!result.monthlyRevenue[month]) {
                    result.monthlyRevenue[month] = 0;
                }
                result.monthlyRevenue[month] += transaction.total;
                
                // Update product sales
                transaction.items.forEach(item => {
                    if (!result.productSales[item.id]) {
                        result.productSales[item.id] = {
                            name: item.name,
                            quantity: 0,
                            revenue: 0
                        };
                    }
                    result.productSales[item.id].quantity += item.qty;
                    result.productSales[item.id].revenue += item.price * item.qty;
                    
                    // Update category revenue (assuming category is in the product name)
                    let category = 'makanan';
                    if (item.name.toLowerCase().includes('kopi') || 
                        item.name.toLowerCase().includes('teh') || 
                        item.name.toLowerCase().includes('milo') || 
                        item.name.toLowerCase().includes('wedang')) {
                        category = 'minuman';
                    }
                    
                    if (!result.categoryRevenue[category]) {
                        result.categoryRevenue[category] = 0;
                    }
                    result.categoryRevenue[category] += item.price * item.qty;
                });
                
                // Update payment methods (assuming all are cash for now)
                if (!result.paymentMethods['Tunai']) {
                    result.paymentMethods['Tunai'] = 0;
                }
                result.paymentMethods['Tunai'] += transaction.total;
            });
            
            // Calculate average transaction
            if (result.totalTransactions > 0) {
                result.avgTransaction = result.totalRevenue / result.totalTransactions;
            }
            
            return result;
        }

        // --- FUNGSI OVERVIEW ---
        function loadOverviewData() {
            // Set default date range (last 30 days)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            document.getElementById('overview-start-date').value = startDate.toISOString().split('T')[0];
            document.getElementById('overview-end-date').value = endDate.toISOString().split('T')[0];
            
            fetchTransactions(startDate, endDate)
                .then(transactions => {
                    if (transactions.length === 0) {
                        showEmptyState();
                        hideLoadingState();
                        return;
                    }
                    
                    const data = processTransactionsData(transactions);
                    
                    // Update stat cards
                    document.getElementById('total-revenue').textContent = formatRupiah(data.totalRevenue);
                    document.getElementById('total-transactions').textContent = data.totalTransactions;
                    document.getElementById('total-items').textContent = data.totalItems;
                    document.getElementById('avg-transaction').textContent = formatRupiah(data.avgTransaction);
                    
                    // Create revenue chart
                    createRevenueChart(data.dailyRevenue);
                    
                    hideLoadingState();
                })
                .catch(error => {
                    console.error("Error loading overview data: ", error);
                    hideLoadingState();
                });
        }

        function filterOverviewData() {
            const startDate = document.getElementById('overview-start-date').value;
            const endDate = document.getElementById('overview-end-date').value;
            
            if (!startDate || !endDate) {
                alert('Silakan pilih tanggal mulai dan tanggal akhir');
                return;
            }
            
            showLoadingState();
            
            fetchTransactions(startDate, endDate)
                .then(transactions => {
                    if (transactions.length === 0) {
                        showEmptyState();
                        hideLoadingState();
                        return;
                    }
                    
                    const data = processTransactionsData(transactions);
                    
                    // Update stat cards
                    document.getElementById('total-revenue').textContent = formatRupiah(data.totalRevenue);
                    document.getElementById('total-transactions').textContent = data.totalTransactions;
                    document.getElementById('total-items').textContent = data.totalItems;
                    document.getElementById('avg-transaction').textContent = formatRupiah(data.avgTransaction);
                    
                    // Create revenue chart
                    createRevenueChart(data.dailyRevenue);
                    
                    hideLoadingState();
                })
                .catch(error => {
                    console.error("Error filtering overview data: ", error);
                    hideLoadingState();
                });
        }

        function createRevenueChart(dailyRevenue) {
            const ctx = document.getElementById('revenue-chart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (charts.revenue) {
                charts.revenue.destroy();
            }
            
            // Sort dates
            const sortedDates = Object.keys(dailyRevenue).sort();
            
            charts.revenue = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Pendapatan Harian',
                        data: sortedDates.map(date => dailyRevenue[date]),
                        backgroundColor: 'rgba(255, 215, 0, 0.2)',
                        borderColor: 'rgba(255, 215, 0, 1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#E0E0E0'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Pendapatan: ' + formatRupiah(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#E0E0E0',
                                callback: function(value) {
                                    return formatRupiah(value);
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#E0E0E0'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // --- FUNGSI PENJUALAN HARIAN ---
        function loadDailyData() {
            // Set default date to today
            const today = new Date();
            document.getElementById('daily-date').value = today.toISOString().split('T')[0];
            
            fetchTransactions(today, today)
                .then(transactions => {
                    if (transactions.length === 0) {
                        showEmptyState();
                        hideLoadingState();
                        return;
                    }
                    
                    const data = processTransactionsData(transactions);
                    
                    // Create hourly chart
                    createDailyChart(data.hourlyRevenue);
                    
                    // Populate transactions table
                    populateDailyTransactionsTable(transactions);
                    
                    hideLoadingState();
                })
                .catch(error => {
                    console.error("Error loading daily data: ", error);
                    hideLoadingState();
                });
        }

        function filterDailyData() {
            const date = document.getElementById('daily-date').value;
            
            if (!date) {
                alert('Silakan pilih tanggal');
                return;
            }
            
            showLoadingState();
            
            fetchTransactions(date, date)
                .then(transactions => {
                    if (transactions.length === 0) {
                        showEmptyState();
                        hideLoadingState();
                        return;
                    }
                    
                    const data = processTransactionsData(transactions);
                    
                    // Create hourly chart
                    createDailyChart(data.hourlyRevenue);
                    
                    // Populate transactions table
                    populateDailyTransactionsTable(transactions);
                    
                    hideLoadingState();
                })
                .catch(error => {
                    console.error("Error filtering daily data: ", error);
                    hideLoadingState();
                });
        }

        function createDailyChart(hourlyRevenue) {
            const ctx = document.getElementById('daily-chart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (charts.daily) {
                charts.daily.destroy();
            }
            
            // Prepare data for all hours (0-23)
            const hours = [];
            const revenues = [];
            
            for (let i = 0; i < 24; i++) {
                hours.push(`${i}:00`);
                revenues.push(hourlyRevenue[i] || 0);
            }
            
            charts.daily = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Pendapatan per Jam',
                        data: revenues,
                        backgroundColor: 'rgba(255, 215, 0, 0.7)',
                        borderColor: 'rgba(255, 215, 0, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#E0E0E0'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Pendapatan: ' + formatRupiah(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#E0E0E0',
                                callback: function(value) {
                                    return formatRupiah(value);
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#E0E0E0'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function populateDailyTransactionsTable(transactions) {
            const tableBody = document.getElementById('daily-transactions-table');
            tableBody.innerHTML = '';
            
            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${transaction.transactionId}</td>
                    <td>${formatDateTime(transaction.timestamp)}</td>
                    <td>${transaction.items.length} item</td>
                    <td>${formatRupiah(transaction.total)}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // --- FUNGSI PENJUALAN MINGGUAN ---
        function loadWeeklyData() {
            // Set default date range (last 7 days)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 7);
            
            document.getElementById('weekly-start-date').value = startDate.toISOString().split('T')[0];
            document.getElementById('weekly-end-date').value = endDate.toISOString().split('T')[0];
            
            fetchTransactions(startDate, endDate)
                .then(transactions => {
                    if (transactions.length === 0) {
                        showEmptyState();
                        hideLoadingState();
                        return;
                    }
                    
                    const data = processTransactionsData(transactions);
                    
                    // Create weekly chart
                    createWeeklyChart(data.weeklyRevenue);
                    
                    // Create category chart
                    createWeeklyCategoryChart(data.categoryRevenue);
                    
                    // Create payment chart
                    createWeeklyPaymentChart(data.paymentMethods);
                    
                    hideLoadingState();
                })
                .catch(error => {
                    console.error("Error loading weekly data: ", error);
                    hideLoadingState();
                });
        }

        function filterWeeklyData() {
            const startDate = document.getElementById('weekly-start-date').value;
            const endDate = document.getElementById('weekly-end-date').value;
            
            if (!startDate || !endDate) {
                alert('Silakan pilih tanggal mulai dan tanggal akhir');
                return;
            }
            
            showLoadingState();
            
            fetchTransactions(startDate, endDate)
                .then(transactions => {
                    if (transactions.length === 0) {
                        showEmptyState();
                        hideLoadingState();
                        return;
                    }
                    
                    const data = processTransactionsData(transactions);
                    
                    // Create weekly chart
                    createWeeklyChart(data.weeklyRevenue);
                    
                    // Create category chart
                    createWeeklyCategoryChart(data.categoryRevenue);
                    
                    // Create payment chart
                    createWeeklyPaymentChart(data.paymentMethods);
                    
                    hideLoadingState();
                })
                .catch(error => {
                    console.error("Error filtering weekly data: ", error);
                    hideLoadingState();
                });
        }

        function createWeeklyChart(weeklyRevenue) {
            const ctx = document.getElementById('weekly-chart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (charts.weekly) {
                charts.weekly.destroy();
            }
            
            // Sort days in correct order
            const daysOrder = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Minggu'];
            const sortedDays = [];
            const revenues = [];
            
            daysOrder.forEach(day => {
                if (weeklyRevenue[day]) {
                    sortedDays.push(day);
                    revenues.push(weeklyRevenue[day]);
                }
            });
            
            charts.weekly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedDays,
                    datasets: [{
                        label: 'Pendapatan per Hari',
                        data: revenues,
                        backgroundColor: 'rgba(255, 215, 0, 0.7)',
                        borderColor: 'rgba(255, 215, 0, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#E0E0E0'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Pendapatan: ' + formatRupiah(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#E0E0E0',
                                callback: function(value) {
                                    return formatRupiah(value);
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#E0E0E0'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function createWeeklyCategoryChart(categoryRevenue) {
            const ctx = document.getElementById('weekly-category-chart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (charts.weeklyCategory) {
                charts.weeklyCategory.destroy();
            }
            
            charts.weeklyCategory = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryRevenue),
                    datasets: [{
                        data: Object.values(categoryRevenue),
                        backgroundColor: [
                            'rgba(255, 215, 0, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(75, 192, 192, 0.7)'
                        ],
                        borderColor: [
                            'rgba(255, 215, 0, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(75, 192, 192, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#E0E0E0'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = formatRupiah(context.raw);
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((context.raw / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createWeeklyPaymentChart(paymentMethods) {
            const ctx = document.getElementById('weekly-payment-chart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (charts.weeklyPayment) {
                charts.weeklyPayment.destroy();
            }
            
            charts.weeklyPayment = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(paymentMethods),
                    datasets: [{
                        data: Object.values(paymentMethods),
                        backgroundColor: [
                            'rgba(255, 215, 0, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(75, 192, 192, 0.7)'
                        ],
                        borderColor: [
                            'rgba(255, 215, 0, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(75, 192, 192, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#E0E0E0'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = formatRupiah(context.raw);
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((context.raw / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- FUNGSI PENJUALAN BULANAN ---
        function loadMonthlyData() {
            // Set default month and year to current month
            const now = new Date();
            document.getElementById('monthly-month').value = now.getMonth();
            
            // Populate year options (current year and 5 years before)
            const yearSelect = document.getElementById('monthly-year');
            yearSelect.innerHTML = '';
            
            for (let i = now.getFullYear(); i >= now.getFullYear() - 5; i--) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                if (i === now.getFullYear()) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
            
            // Load data for current month
            filterMonthlyData();
        }

        function filterMonthlyData() {
            const month = parseInt(document.getElementById('monthly-month').value);
            const year = parseInt(document.getElementById('monthly-year').value);
            
            // Create start and end dates for the selected month
            const startDate = new Date(year, month, 1);
            const endDate = new Date(year, month + 1, 0); // Last day of the month
            
            showLoadingState();
            
            fetchTransactions(startDate, endDate)
                .then(transactions => {
                    if (transactions.length === 0) {
                        showEmptyState();
                        hideLoadingState();
                        return;
                    }
                    
                    const data = processTransactionsData(transactions);
                    
                    // Create monthly chart
                    createMonthlyChart(data.dailyRevenue, month, year);
                    
                    // Create comparison chart
                    createMonthlyComparisonChart(data, month, year);
                    
                    // Create trend chart
                    createMonthlyTrendChart(month, year);
                    
                    hideLoadingState();
                })
                .catch(error => {
                    console.error("Error filtering monthly data: ", error);
                    hideLoadingState();
                });
        }

        function createMonthlyChart(dailyRevenue, month, year) {
            const ctx = document.getElementById('monthly-chart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (charts.monthly) {
                charts.monthly.destroy();
            }
            
            // Get all days in the month
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const days = [];
            const revenues = [];
            
            for (let i = 1; i <= daysInMonth; i++) {
                const date = new Date(year, month, i);
                const dateStr = formatDate(date);
                days.push(i);
                revenues.push(dailyRevenue[dateStr] || 0);
            }
            
            charts.monthly = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'Pendapatan Harian',
                        data: revenues,
                        backgroundColor: 'rgba(255, 215, 0, 0.2)',
                        borderColor: 'rgba(255, 215, 0, 1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#E0E0E0'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Pendapatan: ' + formatRupiah(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#E0E0E0',
                                callback: function(value) {
                                    return formatRupiah(value);
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#E0E0E0'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function createMonthlyComparisonChart(currentData, month, year) {
            const ctx = document.getElementById('monthly-comparison-chart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (charts.monthlyComparison) {
                charts.monthlyComparison.destroy();
            }
            
            // Get previous month data
            const prevMonth = month === 0 ? 11 : month - 1;
            const prevYear = month === 0 ? year - 1 : year;
            
            const prevStartDate = new Date(prevYear, prevMonth, 1);
            const prevEndDate = new Date(prevYear, prevMonth + 1, 0);
            
            fetchTransactions(prevStartDate, prevEndDate)
                .then(prevTransactions => {
                    const prevData = processTransactionsData(prevTransactions);
                    
                    charts.monthlyComparison = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Bulan Lalu', 'Bulan Ini'],
                            datasets: [{
                                label: 'Total Pendapatan',
                                data: [prevData.totalRevenue, currentData.totalRevenue],
                                backgroundColor: [
                                    'rgba(54, 162, 235, 0.7)',
                                    'rgba(255, 215, 0, 0.7)'
                                ],
                                borderColor: [
                                    'rgba(54, 162, 235, 1)',
                                    'rgba(255, 215, 0, 1)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    labels: {
                                        color: '#E0E0E0'
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return 'Pendapatan: ' + formatRupiah(context.raw);
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        color: '#E0E0E0',
                                        callback: function(value) {
                                            return formatRupiah(value);
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        color: '#E0E0E0'
                                    },
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error("Error fetching previous month data: ", error);
                });
        }

        function createMonthlyTrendChart(currentMonth, currentYear) {
            const ctx = document.getElementById('monthly-trend-chart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (charts.monthlyTrend) {
                charts.monthlyTrend.destroy();
            }
            
            // Get data for the last 6 months
            const months = [];
            const revenues = [];
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date(currentYear, currentMonth - i, 1);
                const month = date.toLocaleDateString('id-ID', { month: 'short', year: 'numeric' });
                months.push(month);
                
                // Get the first and last day of the month
                const startDate = new Date(date.getFullYear(), date.getMonth(), 1);
                const endDate = new Date(date.getFullYear(), date.getMonth() + 1, 0);
                
                // Fetch data for this month
                fetchTransactions(startDate, endDate)
                    .then(transactions => {
                        const data = processTransactionsData(transactions);
                        revenues.push(data.totalRevenue);
                        
                        // Create chart when all data is loaded
                        if (revenues.length === 6) {
                            charts.monthlyTrend = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: months,
                                    datasets: [{
                                        label: 'Pendapatan Bulanan',
                                        data: revenues,
                                        backgroundColor: 'rgba(255, 215, 0, 0.2)',
                                        borderColor: 'rgba(255, 215, 0, 1)',
                                        borderWidth: 2,
                                        tension: 0.4,
                                        fill: true
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: {
                                            labels: {
                                                color: '#E0E0E0'
                                            }
                                        },
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    return 'Pendapatan: ' + formatRupiah(context.raw);
                                                }
                                            }
                                        }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            ticks: {
                                                color: '#E0E0E0',
                                                callback: function(value) {
                                                    return formatRupiah(value);
                                                }
                                            },
                                            grid: {
                                                color: 'rgba(255, 255, 255, 0.1)'
                                            }
                                        },
                                        x: {
                                            ticks: {
                                                color: '#E0E0E0'
                                            },
                                            grid: {
                                                color: 'rgba(255, 255, 255, 0.1)'
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    })
                    .catch(error => {
                        console.error("Error fetching monthly trend data: ", error);
                        revenues.push(0);
                    });
            }
        }

        // --- FUNGSI PRODUK TERLARIS ---
        function loadProductsData() {
            // Set default period to this month
            document.getElementById('products-period').value = 'month';
            
            filterProductsData();
        }

        function filterProductsData() {
            const period = document.getElementById('products-period').value;
            
            let startDate, endDate;
            const now = new Date();
            
            switch(period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                    break;
                case 'week':
                    startDate = new Date(now);
                    startDate.setDate(startDate.getDate() - 7);
                    endDate = new Date();
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31);
                    break;
            }
            
            showLoadingState();
            
            fetchTransactions(startDate, endDate)
                .then(transactions => {
                    if (transactions.length === 0) {
                        showEmptyState();
                        hideLoadingState();
                        return;
                    }
                    
                    const data = processTransactionsData(transactions);
                    
                    // Sort products by quantity sold
                    const sortedProducts = Object.values(data.productSales).sort((a, b) => b.quantity - a.quantity);
                    
                    // Create top products chart
                    createTopProductsChart(sortedProducts.slice(0, 10));
                    
                    // Populate top products list
                    populateTopProductsList(sortedProducts.slice(0, 5));
                    
                    hideLoadingState();
                })
                .catch(error => {
                    console.error("Error filtering products data: ", error);
                    hideLoadingState();
                });
        }

        function createTopProductsChart(topProducts) {
            const ctx = document.getElementById('top-products-chart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (charts.topProducts) {
                charts.topProducts.destroy();
            }
            
            charts.topProducts = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topProducts.map(product => product.name),
                    datasets: [{
                        label: 'Jumlah Terjual',
                        data: topProducts.map(product => product.quantity),
                        backgroundColor: 'rgba(255, 215, 0, 0.7)',
                        borderColor: 'rgba(255, 215, 0, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#E0E0E0'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Terjual: ${context.raw} (${formatRupiah(topProducts[context.dataIndex].revenue)})`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                color: '#E0E0E0'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#E0E0E0'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function populateTopProductsList(topProducts) {
            const listContainer = document.getElementById('top-products-list');
            listContainer.innerHTML = '';
            
            topProducts.forEach((product, index) => {
                const productElement = document.createElement('div');
                productElement.className = 'top-product';
                productElement.innerHTML = `
                    <div class="top-product-rank">${index + 1}</div>
                    <div class="top-product-info">
                        <div class="top-product-name">${product.name}</div>
                        <div class="top-product-sales">Terjual: ${product.quantity} item</div>
                    </div>
                    <div class="top-product-revenue">${formatRupiah(product.revenue)}</div>
                `;
                listContainer.appendChild(productElement);
            });
        }

        // --- FUNGSI RIWAYAT TRANSAKSI ---
        function loadTransactionsData() {
            // Set default date range (last 30 days)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            document.getElementById('transactions-start-date').value = startDate.toISOString().split('T')[0];
            document.getElementById('transactions-end-date').value = endDate.toISOString().split('T')[0];
            
            filterTransactionsData();
        }

        function filterTransactionsData() {
            const startDate = document.getElementById('transactions-start-date').value;
            const endDate = document.getElementById('transactions-end-date').value;
            
            if (!startDate || !endDate) {
                alert('Silakan pilih tanggal mulai dan tanggal akhir');
                return;
            }
            
            showLoadingState();
            
            fetchTransactions(startDate, endDate)
                .then(transactions => {
                    if (transactions.length === 0) {
                        showEmptyState();
                        hideLoadingState();
                        return;
                    }
                    
                    // Store transactions globally
                    window.allTransactions = transactions;
                    
                    // Reset pagination
                    currentPage = 1;
                    
                    // Populate transactions table
                    populateTransactionsTable();
                    
                    hideLoadingState();
                })
                .catch(error => {
                    console.error("Error filtering transactions data: ", error);
                    hideLoadingState();
                });
        }

        function populateTransactionsTable() {
            const tableBody = document.getElementById('transactions-table');
            tableBody.innerHTML = '';
            
            // Calculate pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedTransactions = window.allTransactions.slice(startIndex, endIndex);
            
            paginatedTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${transaction.transactionId}</td>
                    <td>${formatDateTime(transaction.timestamp)}</td>
                    <td>${transaction.kasir || 'Kasir'}</td>
                    <td>${transaction.items.length} item</td>
                    <td>${formatRupiah(transaction.total)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="showTransactionDetail('${transaction.id}')">
                            <i class="bi bi-eye"></i> Detail
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Update pagination
            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(window.allTransactions.length / itemsPerPage);
            const pagination = document.getElementById('transactions-pagination');
            pagination.innerHTML = '';
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>`;
            pagination.appendChild(prevLi);
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
                pagination.appendChild(li);
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>`;
            pagination.appendChild(nextLi);
        }

        function changePage(page) {
            const totalPages = Math.ceil(window.allTransactions.length / itemsPerPage);
            
            if (page < 1 || page > totalPages) {
                return;
            }
            
            currentPage = page;
            populateTransactionsTable();
        }

        function showTransactionDetail(transactionId) {
            const transaction = window.allTransactions.find(t => t.id === transactionId);
            
            if (!transaction) {
                return;
            }
            
            const detailContent = document.getElementById('transaction-detail-content');
            
            let itemsHtml = '';
            transaction.items.forEach(item => {
                itemsHtml += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${formatRupiah(item.price)}</td>
                        <td>${item.qty}</td>
                        <td>${formatRupiah(item.price * item.qty)}</td>
                    </tr>
                `;
            });
            
            detailContent.innerHTML = `
                <div class="mb-3">
                    <h5>Informasi Transaksi</h5>
                    <table class="table table-dark">
                        <tr>
                            <td>ID Transaksi</td>
                            <td>${transaction.transactionId}</td>
                        </tr>
                        <tr>
                            <td>Tanggal & Waktu</td>
                            <td>${formatDateTime(transaction.timestamp)}</td>
                        </tr>
                        <tr>
                            <td>Kasir</td>
                            <td>${transaction.kasir || 'Kasir'}</td>
                        </tr>
                    </table>
                </div>
                
                <div class="mb-3">
                    <h5>Detail Pembelian</h5>
                    <table class="table table-dark">
                        <thead>
                            <tr>
                                <th>Produk</th>
                                <th>Harga</th>
                                <th>Jumlah</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3">Subtotal</td>
                                <td>${formatRupiah(transaction.subtotal)}</td>
                            </tr>
                            <tr>
                                <td colspan="3">Diskon (${transaction.discount}%)</td>
                                <td>${formatRupiah(transaction.discountAmount)}</td>
                            </tr>
                            <tr>
                                <td colspan="3">Total</td>
                                <td>${formatRupiah(transaction.total)}</td>
                            </tr>
                            <tr>
                                <td colspan="3">Tunai</td>
                                <td>${formatRupiah(transaction.bayar)}</td>
                            </tr>
                            <tr>
                                <td colspan="3">Kembalian</td>
                                <td>${formatRupiah(transaction.kembalian)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('transactionDetailModal'));
            modal.show();
        }

        function printTransactionDetail() {
            window.print();
        }

        function exportTransactions() {
            // Create CSV content
            let csvContent = "ID Transaksi,Tanggal & Waktu,Kasir,Item,Total\n";
            
            window.allTransactions.forEach(transaction => {
                const items = transaction.items.map(item => `${item.name} (${item.qty}x)`).join(', ');
                csvContent += `${transaction.transactionId},${formatDateTime(transaction.timestamp)},${transaction.kasir || 'Kasir'},"${items}",${transaction.total}\n`;
            });
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `transactions_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- INISIALISASI ---
        document.addEventListener('DOMContentLoaded', () => {
            // Load overview data by default
            loadOverviewData();
            
            // Add event listener for window resize to handle responsive sidebar
            window.addEventListener('resize', () => {
                if (window.innerWidth > 768) {
                    document.getElementById('sidebar').classList.remove('show');
                    document.querySelector('.sidebar-overlay').classList.remove('show');
                }
            });
        });
    </script>
</body>
</html>
