<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN PANEL - WAROENG MASHER</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* CSS Umum (Dark Mode) */
        body { 
            font-family: 'Montserrat', sans-serif; 
            background-color: #1A1A1A;
            scroll-behavior: smooth; 
            color: #E0E0E0;
        }
        h1, h2, h3, h4, h5, h6, .navbar-brand { 
            font-family: 'Lora', serif; 
            font-weight: 700; 
            color: #FFFFFF;
        }
        .navbar-brand { 
            font-weight: bold; 
            color: #FFD700 !important;
            font-size: 1.8rem;
            letter-spacing: 1px;
        }
        .navbar {
            background-color: #282828 !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn-primary { 
            background-color: #FFD700;
            border-color: #FFD700; 
            color: #1A1A1A;
            padding: 10px 20px;
            font-weight: bold; 
            transition: all 0.3s ease; 
        }
        .btn-primary:hover { 
            background-color: #E0B400;
            border-color: #E0B400; 
        }
        .hero-section { 
            height: 60vh;
            background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.9)), url('https://images.unsplash.com/photo-1559925393-8be0ec4767c8?q=80&w=2070&auto=format&fit=crop') no-repeat center center; 
            background-size: cover; 
            background-attachment: fixed; 
            color: white; 
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.7);
        }
        .hero-section h1 { font-size: 3.5rem; }
        
        /* CSS Panel Analisa */
        .dashboard-bg {
            background-color: #282828;
            border-top: 3px solid #FFD700;
            color: #E0E0E0;
        }
        .kpi-card {
            background-color: #333333;
            border: 1px solid #444;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            padding: 20px;
        }
        .kpi-icon {
            font-size: 2.2rem;
            padding: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
        }
        .icon-revenue { background-color: rgba(23, 198, 154, 0.1); color: #17c69a; }
        .icon-order { background-color: rgba(0, 132, 255, 0.1); color: #0084ff; }
        .icon-item { background-color: rgba(255, 202, 40, 0.1); color: #ffca28; }
        .icon-avg { background-color: rgba(249, 80, 98, 0.1); color: #f95062; }
        
        .kpi-card h5 {
            font-size: 0.9rem;
            font-weight: 500;
            color: #B0B0B0;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        .kpi-card .value {
            font-size: 1.7rem;
            font-weight: 700;
            color: #FFFFFF;
            line-height: 1.2;
        }
        .chart-container, .table-container {
            background-color: #333333;
            border: 1px solid #444;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 25px;
            color: #E0E0E0;
        }
        .table-container h5, .chart-container h5 {
            color: #FFD700;
            font-family: 'Lora', serif;
            border-bottom: 1px solid #555;
            padding-bottom: 10px;
        }
        .table thead th {
            border-bottom: 2px solid #555;
            color: #B0B0B0;
        }
        .table tbody td {
            border-color: #444;
            color: #E0E0E0;
        }
    </style>
</head>
<body>
    
    <div id="main-content" style="display: none;">

        <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top shadow-sm">
            <div class="container">
                <a class="navbar-brand" href="#">â˜• ADMIN - WAROENG MASHER</a>
                </div>
        </nav>

        <main id="homepage">
            <header class="hero-section text-white text-center d-flex align-items-center justify-content-center">
                <div class="container">
                    <h1 class="display-4">Selamat Datang, Admin</h1>
                    <p class="lead">Panel keuangan Anda ada di bagian bawah halaman ini.</p>
                    <a href="#financial-analysis-section" class="btn btn-primary btn-lg mt-3">Lihat Analisa Keuangan</a>
                </div>
            </header>
        </main>

        <section id="financial-analysis-section" class="py-5 mt-5 dashboard-bg">
            <div class="container">
                <h2 class="text-center mb-5 display-5" style="color: #FFD700;">ðŸ“Š Panel Analisa Keuangan</h2>
                
                <section class="mb-4">
                    <div class="row g-4">
                        <div class="col-lg-3 col-md-6">
                            <div class="kpi-card">
                                <div class="kpi-icon icon-revenue"><i class="bi bi-cash-stack"></i></div>
                                <div>
                                    <h5>Total Pendapatan</h5>
                                    <span class="value" id="kpi-total-pendapatan">Loading...</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="kpi-card">
                                <div class="kpi-icon icon-order"><i class="bi bi-receipt"></i></div>
                                <div>
                                    <h5>Total Pesanan</h5>
                                    <span class="value" id="kpi-total-pesanan">Loading...</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="kpi-card">
                                <div class="kpi-icon icon-item"><i class="bi bi-box-seam"></i></div>
                                <div>
                                    <h5>Item Terjual</h5>
                                    <span class="value" id="kpi-total-item">Loading...</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="kpi-card">
                                <div class="kpi-icon icon-avg"><i class="bi bi-graph-up-arrow"></i></div>
                                <div>
                                    <h5>Rata-rata/Pesanan</h5>
                                    <span class="value" id="kpi-rata-rata">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="mb-4">
                    <div class="row g-4">
                        <div class="col-lg-8">
                            <div class="chart-container">
                                <h5 class="mb-3">Tren Pendapatan Harian</h5>
                                <canvas id="trenChart"></canvas>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="chart-container">
                                <h5 class="mb-3">Produk Terlaris (Top 5)</h5>
                                <canvas id="kategoriChart" style="max-height: 300px;"></canvas>
                            </div>
                        </div>
                    </div>
                </section>
                
                <section>
                    <div class="table-container">
                        <h5 class="mb-3">5 Transaksi Terakhir</h5>
                        <div class="table-responsive">
                            <table class="table align-middle">
                                <thead>
                                    <tr>
                                        <th>ID Pesanan</th>
                                        <th>Tanggal</th>
                                        <th>Metode</th>
                                        <th class="text-end">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="transaksi-tbody">
                                    <tr><td colspan="4" class="text-center">Memuat data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </div>
        </section>
        <footer class="bg-dark text-white py-4 mt-5">
            <div class="container text-center">
                <p class="mb-0">&copy; 2025 WAROENG MASHER - Made By: studioofficialridho</p>
            </div>
        </footer>

    </div> <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
        // --- INISIALISASI FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyBhRCNri0TjBdMx9fEN8jgAfDD-jV_FdNo",
  authDomain: "waroengmasher.firebaseapp.com",
  projectId: "waroengmasher",
  storageBucket: "waroengmasher.firebasestorage.app",
  messagingSenderId: "984134106741",
  appId: "1:984134106741:web:81d129033d09475173c23c",
  measurementId: "G-7RRW43T1LT"
};
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // --- KODE PASSWORD SEDERHANA (TIDAK AMAN) ---
        //
        // GANTI PASSWORD DI BAWAH INI SESUAI KEINGINAN ANDA
        //
        const ADMIN_PASSWORD = "masheradmin123"; 
        //
        //
        
        const mainContent = document.getElementById('main-content');
        
        function checkAdminLogin() {
            // Minta password menggunakan popup sederhana
            const password = prompt("Silakan masukkan password admin:");
            
            if (password === ADMIN_PASSWORD) {
                // Password benar
                console.log("Password benar. Menampilkan panel admin.");
                mainContent.style.display = 'block'; // Tampilkan konten
                loadFinancialAnalysis(); // Muat data keuangan
            } else {
                // Password salah
                console.log("Password salah.");
                alert("Password Salah! Akses Ditolak.");
                // Sembunyikan semua konten dan tampilkan pesan error
                document.body.innerHTML = '<h1 style="color: red; text-align: center; margin-top: 50px;">AKSES DITOLAK</h1>';
            }
        }
        
        // Fungsi format Rupiah (dibutuhkan panel)
        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
        }

        // --- FUNGSI ANALISIS KEUANGAN (VERSI BARU DENGAN GRAFIK) ---

        let trenChartInstance;
        let kategoriChartInstance;

        async function loadFinancialAnalysis() {
            // Tampilkan loading...
            const kpiPendapatan = document.getElementById('kpi-total-pendapatan');
            const kpiPesanan = document.getElementById('kpi-total-pesanan');
            const kpiItem = document.getElementById('kpi-total-item');
            const kpiRataRata = document.getElementById('kpi-rata-rata');
            const tbody = document.getElementById('transaksi-tbody');
            const loadingHtml = '<span class="spinner-border spinner-border-sm" role="status"></span>';
            
            kpiPendapatan.innerHTML = loadingHtml;
            kpiPesanan.innerHTML = loadingHtml;
            kpiItem.innerHTML = loadingHtml;
            kpiRataRata.innerHTML = loadingHtml;
            tbody.innerHTML = '<tr><td colspan="4" class="text-center">Memuat data dari Firebase...</td></tr>';
            
            try {
                // Ambil data, urutkan dari yang terbaru (descending)
                // Ini akan berhasil karena Aturan Firestore sudah diubah menjadi 'allow read: if true;'
                const ordersRef = db.collection('orders').orderBy('date', 'desc');
                const snapshot = await ordersRef.get();
                
                let totalRevenue = 0;
                let totalOrders = 0;
                let totalItemsSold = 0;
                let dailyRevenue = {}; // Untuk line chart
                let productSales = {}; // Untuk doughnut chart
                let latestTransactions = []; // Untuk tabel
                
                snapshot.forEach(doc => {
                    const order = doc.data();
                    
                    if (typeof order.total !== 'number' || !order.items || !order.date) {
                        return; // Lewati data yang tidak lengkap
                    }

                    totalRevenue += order.total;
                    totalOrders++;
                    
                    if (latestTransactions.length < 5) {
                        latestTransactions.push({
                            id: doc.id.substring(0, 6),
                            date: new Date(order.date).toLocaleDateString('id-ID'),
                            total: order.total,
                            method: order.method || 'N/A'
                        });
                    }

                    const dateStr = new Date(order.date).toLocaleDateString('id-ID', { year: 'numeric', month: 'short', day: 'numeric' });
                    dailyRevenue[dateStr] = (dailyRevenue[dateStr] || 0) + order.total;

                    order.items.forEach(item => {
                        const qty = typeof item.quantity === 'number' ? item.quantity : 0;
                        totalItemsSold += qty;
                        productSales[item.name] = (productSales[item.name] || 0) + qty;
                    });
                });

                const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;

                // RENDER KPI
                kpiPendapatan.innerText = formatRupiah(totalRevenue);
                kpiPesanan.innerText = totalOrders.toLocaleString('id-ID');
                kpiItem.innerText = totalItemsSold.toLocaleString('id-ID');
                kpiRataRata.innerText = formatRupiah(avgOrderValue);

                // RENDER TABEL
                let tableHtml = '';
                if (latestTransactions.length === 0) {
                    tableHtml = '<tr><td colspan="4" class="text-center">Belum ada transaksi.</td></tr>';
                } else {
                    latestTransactions.forEach(trx => {
                        tableHtml += `
                            <tr>
                                <td class="fw-bold">#${trx.id}...</td>
                                <td>${trx.date}</td>
                                <td>${trx.method}</td>
                                <td class="text-end fw-bold">${formatRupiah(trx.total)}</td>
                            </tr>
                        `;
                    });
                }
                tbody.innerHTML = tableHtml;

                // RENDER LINE CHART
                const sortedDailyLabels = Object.keys(dailyRevenue).reverse();
                const sortedDailyData = Object.values(dailyRevenue).reverse();
                const ctxTren = document.getElementById('trenChart').getContext('2d');
                if (trenChartInstance) { trenChartInstance.destroy(); }
                
                trenChartInstance = new Chart(ctxTren, {
                    type: 'line',
                    data: {
                        labels: sortedDailyLabels,
                        datasets: [{
                            label: 'Pendapatan Harian',
                            data: sortedDailyData,
                            borderColor: '#17c69a',
                            backgroundColor: 'rgba(23, 198, 154, 0.1)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                });

                // RENDER DOUGHNUT CHART
                const sortedProducts = Object.entries(productSales).sort(([,a],[,b]) => b-a);
                const topProducts = sortedProducts.slice(0, 5);
                const productLabels = topProducts.map(item => item[0]);
                const productData = topProducts.map(item => item[1]);
                
                const ctxKategori = document.getElementById('kategoriChart').getContext('2d');
                if (kategoriChartInstance) { kategoriChartInstance.destroy(); }
                
                kategoriChartInstance = new Chart(ctxKategori, {
                    type: 'doughnut',
                    data: {
                        labels: productLabels,
                        datasets: [{
                            data: productData,
                            backgroundColor: ['#0084ff', '#17c69a', '#ffca28', '#f95062', '#6c757d'],
                            hoverOffset: 4
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { display: true, position: 'bottom', align: 'start' } } }
                });

            } catch (error) {
                console.error("Gagal memuat Analisis Keuangan:", error);
                document.getElementById('financial-analysis-section').innerHTML = `<div class="container"><p class="text-danger p-4 text-center">Error memuat data: ${error.message}. Periksa koneksi Firebase dan pastikan Aturan (Rules) sudah benar.</p></div>`;
            }
        }
        
        // --- INISIALISASI UTAMA ---
        document.addEventListener('DOMContentLoaded', () => {
            // Sembunyikan konten utama dulu
            mainContent.style.display = 'none'; 
            // Langsung minta password
            checkAdminLogin();
        });
    </script>
</body>

</html>
